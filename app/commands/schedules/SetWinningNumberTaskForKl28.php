<?php/** * Created by PhpStorm. * User: endless * Date: 15-10-5 * Time: 上午10:52 * 1,通过lottery_id和issue在project表里获取project_id * 2,通过 */class SetWinningNumberTaskForKl28 extends BaseTask { public $oPassiveRecord; protected function doCommand(){  extract($this->data);  $sWnNumber = strlen($sWnNumber) == 3 ? $sWnNumber : substr($sWnNumber,0,3);  $this->log = 'begin getting the code';  $oLottery = Lottery::find($lottery_id);  if (!$oLottery) {   $this->log = "missing lottery, lottery_id=" . $lottery_id;   return self::TASK_SUCCESS;  }  if(!$sIssue) $oLastIssue = ManIssue::getLatestIssueOfNoWnNumber($lottery_id);  else $oLastIssue = ManIssue::getIssue($lottery_id,$sIssue);  if (!$oLastIssue) {   $this->log = "No issue, lottery_id=" . $lottery_id;   return self::TASK_SUCCESS;  }  $this->log = 'lottery_id = ' . $lottery_id . ', issue=' . $oLastIssue->issue;  $oCodeCenter = CodeCenter::getCenter(2);//  $this->log = 'code center get_url=' . $oCodeCenter->domain . $oCodeCenter->get_url;//  $this->oPassiveRecord = new PassiveRecord;//  $this->oPassiveRecord->lottery_id = $lottery_id;//  $this->oPassiveRecord->codecenter_id = $oCodeCenter->id;//  $this->oPassiveRecord->request_lottery = $oLottery->identifier;//  $this->oPassiveRecord->issue = $oLastIssue->issue;//  $this->oPassiveRecord->customer_key = $oCodeCenter->customer_key;//  $this->oPassiveRecord->request_time = microtime(true);//  $this->oPassiveRecord->save();  if ($oLottery->checkWinningNumber($sWnNumber)) {   if ($oLastIssue->setWinningNumber($sWnNumber, $oCodeCenter) === true) {//    $this->oPassiveRecord->code = $sWnNumber;    $oLastIssue->setCalculateTask();    $this->log = 'lottery_id = ' . $lottery_id . ', issue = ' . $oLastIssue->issue . ', code = ' . $sWnNumber . ', saved success!';    return self::TASK_SUCCESS;   } else {    $this->log = 'lottery_id = ' . $lottery_id . ', issue = ' . $oLastIssue->issue . ', code = ' . $sWnNumber . ', saved fail!';    return self::TASK_SUCCESS;   }  } else {   $this->log = 'lottery_id = ' . $lottery_id . ', issue = ' . $oLastIssue->issue . ', code = ' . $sWnNumber . ', format is not correct';   return self::TASK_SUCCESS;  } }}